cmake_minimum_required(VERSION 3.12)

cmake_policy(SET CMP0074 NEW)
set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

project(externalLib)
include(ExternalProject)

set(USE_MPI OFF)
set(MPI_FOUND OFF)
set(USE_OMP ON)
set(USE_OCL OFF)
set(EXTERNAL_BUILD_THREADS 10 CACHE STRING "Build vars")

if(BUILD_VTK)
     ExternalProject_Add(
	    VTK
	    DEPENDS proj4
	    URL http://www.vtk.org/files/release/8.1/VTK-8.1.1.tar.gz
	    UPDATE_COMMAND ""
	    CMAKE_ARGS -DCMAKE_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/lib/VTK -DCMAKE_BUILD_TYPE=Release
	                -DVTK_USE_SYSTEM_libproj4=ON
	                -DLIBPROJ4_LIBRARIES=${CMAKE_BINARY_DIR}/lib/proj4/lib/libproj.so -DLIBPROJ4_INCLUDE_DIR=${CMAKE_BINARY_DIR}/lib/proj4/include
	    BUILD_COMMAND make -j${EXTERNAL_BUILD_THREADS}
	    INSTALL_COMMAND make install
	    BUILD_IN_SOURCE 1
	    )
endif()

if(BUILD_FUNC)
    ExternalProject_Add(
        func
        GIT_REPOSITORY https://github.com/uofs-simlab/func.git
        UPDATE_COMMAND ""
        CMAKE_ARGS -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/lib/func
        BUILD_COMMAND make -j${EXTERNAL_BUILD_THREADS}
        INSTALL_COMMAND make install
        BUILD_IN_SOURCE 1
        )
endif()

#Paraview (<=5.1.2  -- unsure on 5.5+) still needs to build it's own VTK.
# Since we have to carefully build VTK to avoid netcdf/proj4 compatibility issues, it is best to just let PV do its own thing
#https://public.kitware.com/pipermail/paraview/2016-August/037922.html
#Super build would be nice to use, however it doesn't compile if within a git sub-tree. Unsure how to work around this.
if(BUILD_ParaView)

     ExternalProject_Add(
	    ParaView
        #5.4.1 is what is on Graham
	    URL https://www.paraview.org/paraview-downloads/download.php?submit=Download&version=v5.4&type=source&os=Sources&downloadFile=ParaView-v5.4.1.tar.gz

	    UPDATE_COMMAND ""
	    CMAKE_ARGS -DMACOSX_APP_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/lib/ParaView
	                -DCMAKE_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/lib/ParaView
	                -DCMAKE_BUILD_TYPE=Release
	                -DCMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH}
	                -DCMAKE_PREFIX_PATH=/usr/local/opt/qt    #$(brew --prefix qt5)
	    BUILD_COMMAND make -j${EXTERNAL_BUILD_THREADS}
	    INSTALL_COMMAND make install
	    PATCH_COMMAND patch -p1  < ${CMAKE_BINARY_DIR}/paraview-5.4.1.patch
	    BUILD_IN_SOURCE 0
	 )

	#build the datetime filter
	#this uses
    ExternalProject_Add(
    	    vtk-timefilter
            DEPENDS ParaView

    	    GIT_REPOSITORY https://github.com/Chrismarsh/vtk-paraview-datetimefilter.git

            CMAKE_ARGS  -DCMAKE_INSTALL_PREFIX=${CMAKE_BINARY_DIR}/lib/vtk-datetime-filter
                        -DParaView_DIR=${CMAKE_BINARY_DIR}/lib/ParaView-prefix/src/ParaView-build
                        -DCMAKE_PREFIX_PATH=/usr/local/opt/qt #$(brew --prefix qt5)
    	    UPDATE_COMMAND ""
    	    BUILD_COMMAND make -j${EXTERNAL_BUILD_THREADS}
    	    INSTALL_COMMAND make install
    	    BUILD_IN_SOURCE 1
    	 )
endif()

if(BUILD_GDAL)

    ExternalProject_Add(
	    GDAL
	    #DEPENDS proj4
	    URL http://download.osgeo.org/gdal/2.4.1/gdal-2.4.1.tar.gz

	    UPDATE_COMMAND ""
	    #PATCH_COMMAND patch -p1 < ${CMAKE_BINARY_DIR}/gdal-2.2.1.patch

	    #occasionally GDAL doesn't correctly detect this, so can enable if required by adding before the configure command
	    #http://osgeo-org.1560.x6.nabble.com/gdal-dev-sprintf-different-exception-specified-td5340324.html
	    # CXXFLAGS=-DDONT_DEPRECATE_SPRINTF

	    CONFIGURE_COMMAND <SOURCE_DIR>/configure  --prefix=${CMAKE_BINARY_DIR}/lib/gdal --with-static-proj4=${CMAKE_BINARY_DIR}/lib/proj4
                                                      --with-geos
                                                      --with-geotiff=internal
                                                      --with-hide-internal-symbols
                                                      --with-libtiff=internal
                                                      --with-libz=internal
                                                      --with-threads
                                                      --without-bsb
                                                      --without-cfitsio
                                                      --without-cryptopp
                                                      --without-curl
                                                      --without-ecw
                                                      --without-expat
                                                      --without-fme
                                                      --without-freexl
                                                      --without-gif
                                                      --without-gif
                                                      --without-gnm
                                                      --without-grass
                                                      --without-grib
                                                      --without-hdf4
                                                      --without-hdf5
                                                      --without-idb
                                                      --without-ingres
                                                      --without-jasper
                                                      --without-jp2mrsid
                                                      --without-jpeg
                                                      --without-kakadu
                                                      --without-libgrass
                                                      --without-libkml
                                                      --without-libtool
                                                      --without-mrf
                                                      --without-mrsid
                                                      --without-mysql
                                                      --without-netcdf
                                                      --without-odbc
                                                      --without-ogdi
                                                      --without-openjpeg
                                                      --without-pcidsk
                                                      --without-pcraster
                                                      --without-pcre
                                                      --without-perl
                                                      --without-pg
                                                      --without-png
                                                      --without-python
                                                      --without-qhull
                                                      --without-sde
                                                      --without-sqlite3
                                                      --without-webp
                                                      --without-xerces
                                                      --without-xml2
                                                      --without-crypto
                                                      --without-kea

	    BUILD_COMMAND make -j${EXTERNAL_BUILD_THREADS}
	    INSTALL_COMMAND make install
	    BUILD_IN_SOURCE 1
	    )
endif()

